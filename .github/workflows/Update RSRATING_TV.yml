name: Update RSRATING_TV.CSV

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * 1-5'  # Runs at 10:00 PM UTC (6:00 PM EST) Mon-Fri

jobs:
  update-rsrating:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install pandas

      - name: Update RSRATING_TV.csv
        run: |
          python << 'EOF'
          import pandas as pd
          import datetime as dt

          input_file = "RS_Data/RSRATING.csv"
          output_file = "RS_Data/RSRATING_TV.csv"

          # Generate last 35 calendar days ending today, oldest first
          today = dt.date.today()
          dates = [(today - dt.timedelta(days=i)).strftime("%Y%m%dT") for i in range(34, -1, -1)]

          # Read CSV and replace the first column with new dates
          df = pd.read_csv(input_file, header=None)
          if len(df) >= 35:
              df.iloc[:35, 0] = dates
          else:
              df.iloc[:, 0] = dates[:len(df)]

          # Save updated CSV
          df.to_csv(input_file, index=False, header=False)

          # Process RSRATING_TV output
          df = pd.read_csv(input_file, header=None)
          df.to_csv(output_file, index=False, header=False)
          EOF

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add RS_Data/RSRATING.csv RS_Data/RSRATING_TV.csv
          git commit -m "Update RSRATING files with last 35 calendar days"
          git push
